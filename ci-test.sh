[38;5;243m#[0m[38;5;243m!/bin/bash[0m
[38;5;243m#[0m[38;5;243m CI End-to-End Test Script[0m
[38;5;243m#[0m[38;5;243m This script runs a complete end-to-end test suitable for CI pipelines[0m

[38;5;81mset[0m[38;5;231m -euo pipefail[0m

[38;5;231mSCRIPT_DIR[0m[38;5;203m=[0m[38;5;231m"[0m[38;5;231m$[0m[38;5;186m([0m[38;5;81mcd[0m[38;5;186m [0m[38;5;231m"[0m[38;5;231m$[0m[38;5;186m([0m[38;5;231mdirname[0m[38;5;186m [0m[38;5;231m"[0m[38;5;231m$[0m[38;5;186m{[0m[38;5;231mBASH_SOURCE[0m[38;5;231m[[0m[38;5;141m0[0m[38;5;231m][0m[38;5;186m}[0m[38;5;231m"[0m[38;5;186m)[0m[38;5;231m"[0m[38;5;186m [0m[38;5;203m&&[0m[38;5;186m [0m[38;5;231mpwd[0m[38;5;186m)[0m[38;5;231m"[0m
[38;5;81mcd[0m[38;5;231m [0m[38;5;231m"[0m[38;5;231m$[0m[38;5;231mSCRIPT_DIR[0m[38;5;231m"[0m

[38;5;243m#[0m[38;5;243m Colors[0m
[38;5;231mGREEN[0m[38;5;203m=[0m[38;5;231m'[0m[38;5;186m\033[0;32m[0m[38;5;231m'[0m
[38;5;231mRED[0m[38;5;203m=[0m[38;5;231m'[0m[38;5;186m\033[0;31m[0m[38;5;231m'[0m
[38;5;231mYELLOW[0m[38;5;203m=[0m[38;5;231m'[0m[38;5;186m\033[1;33m[0m[38;5;231m'[0m
[38;5;231mNC[0m[38;5;203m=[0m[38;5;231m'[0m[38;5;186m\033[0m[0m[38;5;231m'[0m

[38;5;149mlog[0m[38;5;231m([0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;231m    [0m[38;5;81mecho[0m[38;5;231m [0m[38;5;208m-[0m[38;5;208me[0m[38;5;231m [0m[38;5;231m"[0m[38;5;231m$[0m[38;5;186m{[0m[38;5;231mGREEN[0m[38;5;186m}[0m[38;5;186m[[0m[38;5;231m$[0m[38;5;186m([0m[38;5;231mdate[0m[38;5;186m +[0m[38;5;231m'[0m[38;5;186m%H:%M:%S[0m[38;5;231m'[0m[38;5;186m)[0m[38;5;186m][0m[38;5;231m$[0m[38;5;186m{[0m[38;5;231mNC[0m[38;5;186m}[0m[38;5;186m [0m[38;5;231m$[0m[38;5;231m1[0m[38;5;231m"[0m
[38;5;231m}[0m

[38;5;149merror[0m[38;5;231m([0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;231m    [0m[38;5;81mecho[0m[38;5;231m [0m[38;5;208m-[0m[38;5;208me[0m[38;5;231m [0m[38;5;231m"[0m[38;5;231m$[0m[38;5;186m{[0m[38;5;231mRED[0m[38;5;186m}[0m[38;5;186m[ERROR][0m[38;5;231m$[0m[38;5;186m{[0m[38;5;231mNC[0m[38;5;186m}[0m[38;5;186m [0m[38;5;231m$[0m[38;5;231m1[0m[38;5;231m"[0m
[38;5;231m    [0m[38;5;81mexit[0m[38;5;231m 1[0m
[38;5;231m}[0m

[38;5;149mwarn[0m[38;5;231m([0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;231m    [0m[38;5;81mecho[0m[38;5;231m [0m[38;5;208m-[0m[38;5;208me[0m[38;5;231m [0m[38;5;231m"[0m[38;5;231m$[0m[38;5;186m{[0m[38;5;231mYELLOW[0m[38;5;186m}[0m[38;5;186m[WARN][0m[38;5;231m$[0m[38;5;186m{[0m[38;5;231mNC[0m[38;5;186m}[0m[38;5;186m [0m[38;5;231m$[0m[38;5;231m1[0m[38;5;231m"[0m
[38;5;231m}[0m

[38;5;243m#[0m[38;5;243m Cleanup function[0m
[38;5;149mcleanup[0m[38;5;231m([0m[38;5;231m)[0m[38;5;231m [0m[38;5;231m{[0m
[38;5;231m    [0m[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mCleaning up...[0m[38;5;231m"[0m
[38;5;231m    [0m[38;5;231mpkill[0m[38;5;208m -[0m[38;5;208mf[0m[38;5;231m qemu-system-aarch64 [0m[38;5;141m2[0m[38;5;203m>[0m[38;5;231m/dev/null[0m[38;5;231m [0m[38;5;203m||[0m[38;5;231m [0m[38;5;231mtrue[0m
[38;5;231m    [0m[38;5;231mrm[0m[38;5;208m -[0m[38;5;208mf[0m[38;5;231m ztpbootstrap-test[0m[38;5;203m*[0m[38;5;231m.qcow2 [0m[38;5;141m2[0m[38;5;203m>[0m[38;5;231m/dev/null[0m[38;5;231m [0m[38;5;203m||[0m[38;5;231m [0m[38;5;231mtrue[0m
[38;5;231m}[0m

[38;5;81mtrap[0m[38;5;231m cleanup EXIT[0m

[38;5;243m#[0m[38;5;243m Step 1: Create VM[0m
[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mStep 1: Creating VM...[0m[38;5;231m"[0m
[38;5;231m./vm-create-native.sh[0m[38;5;208m --[0m[38;5;208mdownload[0m[38;5;231m fedora[0m[38;5;208m --[0m[38;5;208mtype[0m[38;5;231m cloud[0m[38;5;208m --[0m[38;5;208march[0m[38;5;231m aarch64[0m[38;5;208m --[0m[38;5;208mversion[0m[38;5;231m 43[0m[38;5;208m --[0m[38;5;208mheadless[0m[38;5;231m [0m[38;5;203m>[0m[38;5;231m /tmp/ci-vm-create.log [0m[38;5;141m2[0m[38;5;203m>&[0m[38;5;141m1[0m[38;5;231m [0m[38;5;203m&[0m
[38;5;231mVM_PID[0m[38;5;203m=[0m[38;5;231m$[0m[38;5;231m![0m

[38;5;243m#[0m[38;5;243m Wait for VM to start[0m
[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mWaiting for VM to boot...[0m[38;5;231m"[0m
[38;5;231msleep[0m[38;5;231m 90[0m

[38;5;243m#[0m[38;5;243m Check if VM is running[0m
[38;5;203mif[0m[38;5;231m [0m[38;5;203m![0m[38;5;231m [0m[38;5;231mps[0m[38;5;208m -[0m[38;5;208mp[0m[38;5;231m [0m[38;5;231m$[0m[38;5;231mVM_PID[0m[38;5;231m [0m[38;5;203m>[0m[38;5;231m /dev/null [0m[38;5;141m2[0m[38;5;203m>&[0m[38;5;141m1[0m[38;5;203m;[0m[38;5;231m [0m[38;5;203mthen[0m
[38;5;231m    [0m[38;5;231merror[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mVM creation process exited unexpectedly[0m[38;5;231m"[0m
[38;5;203mfi[0m

[38;5;203mif[0m[38;5;231m [0m[38;5;203m![0m[38;5;231m [0m[38;5;231mps[0m[38;5;231m aux[0m[38;5;231m [0m[38;5;203m|[0m[38;5;231m [0m[38;5;231mgrep[0m[38;5;208m -[0m[38;5;208mi[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mqemu-system-aarch64[0m[38;5;231m"[0m[38;5;231m [0m[38;5;203m|[0m[38;5;231m [0m[38;5;231mgrep[0m[38;5;208m -[0m[38;5;208mv[0m[38;5;231m grep [0m[38;5;203m>[0m[38;5;231m /dev/null[0m[38;5;203m;[0m[38;5;231m [0m[38;5;203mthen[0m
[38;5;231m    [0m[38;5;231merror[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mVM is not running[0m[38;5;231m"[0m
[38;5;203mfi[0m

[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mâœ“ VM is running[0m[38;5;231m"[0m

[38;5;243m#[0m[38;5;243m Step 2: Wait for cloud-init and test SSH[0m
[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mStep 2: Waiting for cloud-init and testing SSH...[0m[38;5;231m"[0m
[38;5;231mSSH_SUCCESS[0m[38;5;203m=[0m[38;5;186mfalse[0m
[38;5;203mfor[0m[38;5;231m i [0m[38;5;203min[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m1..30[0m[38;5;231m}[0m[38;5;203m;[0m[38;5;231m [0m[38;5;203mdo[0m
[38;5;231m    [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231mssh[0m[38;5;208m -[0m[38;5;208mo[0m[38;5;231m ConnectTimeout=5[0m[38;5;208m -[0m[38;5;208mo[0m[38;5;231m StrictHostKeyChecking=no[0m[38;5;208m -[0m[38;5;208mo[0m[38;5;231m UserKnownHostsFile=/dev/null[0m[38;5;208m -[0m[38;5;208mp[0m[38;5;231m 2222 fedora@localhost [0m[38;5;231m"[0m[38;5;186mecho test[0m[38;5;231m"[0m[38;5;231m [0m[38;5;203m>[0m[38;5;231m /dev/null [0m[38;5;141m2[0m[38;5;203m>&[0m[38;5;141m1[0m[38;5;203m;[0m[38;5;231m [0m[38;5;203mthen[0m
[38;5;231m        [0m[38;5;231mSSH_SUCCESS[0m[38;5;203m=[0m[38;5;186mtrue[0m
[38;5;231m        [0m[38;5;203mbreak[0m
[38;5;231m    [0m[38;5;203mfi[0m
[38;5;231m    [0m[38;5;231msleep[0m[38;5;231m 10[0m
[38;5;203mdone[0m

[38;5;203mif[0m[38;5;231m [0m[38;5;81m[[0m[38;5;231m [0m[38;5;231m"[0m[38;5;231m$[0m[38;5;231mSSH_SUCCESS[0m[38;5;231m"[0m[38;5;231m [0m[38;5;203m!=[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mtrue[0m[38;5;231m"[0m[38;5;231m [0m[38;5;81m][0m[38;5;203m;[0m[38;5;231m [0m[38;5;203mthen[0m
[38;5;231m    [0m[38;5;231merror[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mSSH connection failed after 5 minutes[0m[38;5;231m"[0m
[38;5;203mfi[0m

[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mâœ“ SSH connection successful[0m[38;5;231m"[0m

[38;5;243m#[0m[38;5;243m Step 3: Verify repository[0m
[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mStep 3: Verifying repository clone...[0m[38;5;231m"[0m
[38;5;203mif[0m[38;5;231m [0m[38;5;203m![0m[38;5;231m [0m[38;5;231mssh[0m[38;5;208m -[0m[38;5;208mo[0m[38;5;231m ConnectTimeout=10[0m[38;5;208m -[0m[38;5;208mo[0m[38;5;231m StrictHostKeyChecking=no[0m[38;5;208m -[0m[38;5;208mo[0m[38;5;231m UserKnownHostsFile=/dev/null[0m[38;5;208m -[0m[38;5;208mp[0m[38;5;231m 2222 fedora@localhost [0m[38;5;231m"[0m[38;5;186mtest -f ~/ztpbootstrap/setup.sh[0m[38;5;231m"[0m[38;5;231m [0m[38;5;141m2[0m[38;5;203m>[0m[38;5;231m/dev/null[0m[38;5;203m;[0m[38;5;231m [0m[38;5;203mthen[0m
[38;5;231m    [0m[38;5;231merror[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mRepository not cloned or setup.sh not found[0m[38;5;231m"[0m
[38;5;203mfi[0m

[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mâœ“ Repository cloned successfully[0m[38;5;231m"[0m

[38;5;243m#[0m[38;5;243m Step 4: Run service setup[0m
[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mStep 4: Running service setup...[0m[38;5;231m"[0m
[38;5;203mif[0m[38;5;231m [0m[38;5;203m![0m[38;5;231m [0m[38;5;231mssh[0m[38;5;208m -[0m[38;5;208mo[0m[38;5;231m ConnectTimeout=10[0m[38;5;208m -[0m[38;5;208mo[0m[38;5;231m StrictHostKeyChecking=no[0m[38;5;208m -[0m[38;5;208mo[0m[38;5;231m UserKnownHostsFile=/dev/null[0m[38;5;208m -[0m[38;5;208mp[0m[38;5;231m 2222 fedora@localhost [0m[38;5;231m"[0m[38;5;186mcd ~/ztpbootstrap && sudo ./setup.sh --http-only[0m[38;5;231m"[0m[38;5;231m [0m[38;5;203m>[0m[38;5;231m /tmp/ci-setup.log [0m[38;5;141m2[0m[38;5;203m>&[0m[38;5;141m1[0m[38;5;203m;[0m[38;5;231m [0m[38;5;203mthen[0m
[38;5;231m    [0m[38;5;231merror[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mService setup failed[0m[38;5;231m"[0m
[38;5;203mfi[0m

[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mâœ“ Service setup completed[0m[38;5;231m"[0m

[38;5;243m#[0m[38;5;243m Step 5: Verify services[0m
[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mStep 5: Verifying services...[0m[38;5;231m"[0m
[38;5;231msleep[0m[38;5;231m 30[0m

[38;5;243m#[0m[38;5;243m Check systemd services[0m
[38;5;203mif[0m[38;5;231m [0m[38;5;203m![0m[38;5;231m [0m[38;5;231mssh[0m[38;5;208m -[0m[38;5;208mo[0m[38;5;231m ConnectTimeout=10[0m[38;5;208m -[0m[38;5;208mo[0m[38;5;231m StrictHostKeyChecking=no[0m[38;5;208m -[0m[38;5;208mo[0m[38;5;231m UserKnownHostsFile=/dev/null[0m[38;5;208m -[0m[38;5;208mp[0m[38;5;231m 2222 fedora@localhost [0m[38;5;231m"[0m[38;5;186msudo systemctl is-active ztpbootstrap > /dev/null 2>&1[0m[38;5;231m"[0m[38;5;231m [0m[38;5;141m2[0m[38;5;203m>[0m[38;5;231m/dev/null[0m[38;5;203m;[0m[38;5;231m [0m[38;5;203mthen[0m
[38;5;231m    [0m[38;5;231mwarn[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mPod service not active, checking status...[0m[38;5;231m"[0m
[38;5;231m    [0m[38;5;231mssh[0m[38;5;208m -[0m[38;5;208mo[0m[38;5;231m ConnectTimeout=10[0m[38;5;208m -[0m[38;5;208mo[0m[38;5;231m StrictHostKeyChecking=no[0m[38;5;208m -[0m[38;5;208mo[0m[38;5;231m UserKnownHostsFile=/dev/null[0m[38;5;208m -[0m[38;5;208mp[0m[38;5;231m 2222 fedora@localhost [0m[38;5;231m"[0m[38;5;186msudo systemctl status ztpbootstrap --no-pager | head -20[0m[38;5;231m"[0m[38;5;231m [0m[38;5;141m2[0m[38;5;203m>&[0m[38;5;141m1[0m[38;5;231m [0m[38;5;203m||[0m[38;5;231m [0m[38;5;231mtrue[0m
[38;5;203mfi[0m

[38;5;243m#[0m[38;5;243m Step 6: Test health endpoint[0m
[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mStep 6: Testing health endpoint...[0m[38;5;231m"[0m
[38;5;231mHEALTH_SUCCESS[0m[38;5;203m=[0m[38;5;186mfalse[0m
[38;5;203mfor[0m[38;5;231m i [0m[38;5;203min[0m[38;5;231m [0m[38;5;231m{[0m[38;5;231m1..10[0m[38;5;231m}[0m[38;5;203m;[0m[38;5;231m [0m[38;5;203mdo[0m
[38;5;231m    [0m[38;5;203mif[0m[38;5;231m [0m[38;5;231mcurl[0m[38;5;208m -[0m[38;5;208ms[0m[38;5;231m http://localhost:8080/health [0m[38;5;203m>[0m[38;5;231m /dev/null [0m[38;5;141m2[0m[38;5;203m>&[0m[38;5;141m1[0m[38;5;203m;[0m[38;5;231m [0m[38;5;203mthen[0m
[38;5;231m        [0m[38;5;231mHEALTH_SUCCESS[0m[38;5;203m=[0m[38;5;186mtrue[0m
[38;5;231m        [0m[38;5;203mbreak[0m
[38;5;231m    [0m[38;5;203mfi[0m
[38;5;231m    [0m[38;5;231msleep[0m[38;5;231m 5[0m
[38;5;203mdone[0m

[38;5;203mif[0m[38;5;231m [0m[38;5;81m[[0m[38;5;231m [0m[38;5;231m"[0m[38;5;231m$[0m[38;5;231mHEALTH_SUCCESS[0m[38;5;231m"[0m[38;5;231m [0m[38;5;203m!=[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mtrue[0m[38;5;231m"[0m[38;5;231m [0m[38;5;81m][0m[38;5;203m;[0m[38;5;231m [0m[38;5;203mthen[0m
[38;5;231m    [0m[38;5;231mwarn[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mHealth endpoint not accessible (may need more time)[0m[38;5;231m"[0m
[38;5;203melse[0m
[38;5;231m    [0m[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mâœ“ Health endpoint accessible[0m[38;5;231m"[0m
[38;5;203mfi[0m

[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;231m"[0m
[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186m=== CI Test Complete ===[0m[38;5;231m"[0m
[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mAll automated steps completed successfully![0m[38;5;231m"[0m
[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;231m"[0m
[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186mSummary:[0m[38;5;231m"[0m
[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186m  âœ… VM Creation[0m[38;5;231m"[0m
[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186m  âœ… SSH Access[0m[38;5;231m"[0m
[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186m  âœ… Repository Clone[0m[38;5;231m"[0m
[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186m  âœ… Service Setup[0m[38;5;231m"[0m
[38;5;231mlog[0m[38;5;231m [0m[38;5;231m"[0m[38;5;186m  âœ… Health Endpoint[0m[38;5;231m"[0m

[38;5;81mexit[0m[38;5;231m 0[0m
